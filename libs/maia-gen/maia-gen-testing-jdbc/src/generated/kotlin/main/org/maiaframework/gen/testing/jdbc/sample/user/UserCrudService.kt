// This source was generated by the Maia Framework code generator
// Renderer class: class org.maiaframework.gen.renderers.CrudServiceRenderer

package org.maiaframework.gen.testing.jdbc.sample.user

import org.maiaframework.domain.DomainId
import org.maiaframework.domain.contact.EmailAddress
import org.maiaframework.domain.party.FirstName
import org.maiaframework.domain.party.LastName
import org.maiaframework.problem.MaiaProblems
import org.maiaframework.webapp.domain.auth.CurrentUserHolder
import org.slf4j.LoggerFactory
import org.springframework.stereotype.Component
import java.time.Instant


@Component
class UserCrudService(
    private val entityRepo: UserRepo,
    private val maiaProblems: MaiaProblems,
    private val userCrudNotifier: UserCrudNotifier
) {


    private val logger = LoggerFactory.getLogger(UserCrudService::class.java)


    fun create(createDto: UserCreateRequestDto): UserEntity {

        logger.info("BEGIN: create User. dto=$createDto")

        val entity: UserEntity = buildEntity(createDto)
        return create(entity)

    }


    private fun buildEntity(createDto: UserCreateRequestDto): UserEntity {

        val displayName: String = "DERIVED"
        val emailAddress: EmailAddress = createDto.emailAddress
        val encryptedPassword: String = createDto.encryptedPassword
        val firstName: FirstName? = createDto.firstName
        val lastName: LastName = createDto.lastName
        val someStrings: List<String> = createDto.someStrings
        val id = DomainId.newId()
        val createdTimestampUtc = Instant.now()
        val lastModifiedTimestampUtc = createdTimestampUtc

        return UserEntity(
            createdTimestampUtc,
            displayName,
            emailAddress,
            encryptedPassword,
            firstName,
            id,
            lastModifiedTimestampUtc,
            lastName,
            someStrings
        )

    }


    fun create(entity: UserEntity): UserEntity {

        this.entityRepo.insert(entity)
        this.userCrudNotifier.onEntityCreated(entity)
        return entity

    }


    fun update(editDto: UserUpdateRequestDto) {

        val id = editDto.id
        val updater = UserEntityUpdater.forPrimaryKey(id) {
            lastName(editDto.lastName)
            firstName(editDto.firstName)
            lastModifiedTimestampUtc(Instant.now())
        }.build()

        setFields(updater)

    }


    fun updateFirstName(editDto: UserUpdate_firstNameRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateFirstName. currentUser=${currentUser.username}, dto=$editDto")

        val updater = UserEntityUpdater.forPrimaryKey(editDto.id) {
            firstName(editDto.firstName)
        }.build()

        setFields(updater)

    }


    fun updateLastName(editDto: UserUpdate_lastNameRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateLastName. currentUser=${currentUser.username}, dto=$editDto")

        val updater = UserEntityUpdater.forPrimaryKey(editDto.id) {
            lastName(editDto.lastName)
        }.build()

        setFields(updater)

    }


    fun setFields(updater: UserEntityUpdater): Int {
        
        val count = this.entityRepo.setFields(updater)
        this.userCrudNotifier.onEntityUpdated(updater.id)
        return count
        
    }


}

