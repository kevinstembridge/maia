// This source was generated by the Maia Framework code generator
// Renderer class: class org.maiaframework.gen.renderers.CrudServiceRenderer

package org.maiaframework.gen.testing.jdbc.sample.join

import org.maiaframework.domain.DomainId
import org.maiaframework.problem.MaiaProblems
import org.maiaframework.webapp.domain.auth.CurrentUserHolder
import org.slf4j.LoggerFactory
import org.springframework.stereotype.Component
import java.time.Instant


@Component
class CharlieCrudService(
    private val charlieCrudNotifier: CharlieCrudNotifier,
    private val entityRepo: CharlieRepo,
    private val maiaProblems: MaiaProblems
) {


    private val logger = LoggerFactory.getLogger(CharlieCrudService::class.java)


    fun create(createDto: CharlieCreateRequestDto): CharlieEntity {

        logger.info("BEGIN: create Charlie. dto=$createDto")

        val entity: CharlieEntity = buildEntity(createDto)
        return create(entity)

    }


    private fun buildEntity(createDto: CharlieCreateRequestDto): CharlieEntity {

        val bravoId: DomainId = createDto.bravoId
        val someInt: Int = createDto.someInt
        val someString: String = createDto.someString
        val id = DomainId.newId()
        val createdTimestampUtc = Instant.now()

        return CharlieEntity(
            bravoId,
            createdTimestampUtc,
            id,
            someInt,
            someString
        )

    }


    fun create(entity: CharlieEntity): CharlieEntity {

        this.entityRepo.insert(entity)
        this.charlieCrudNotifier.onEntityCreated(entity)
        return entity

    }


    fun update(editDto: CharlieUpdateRequestDto) {

        val id = editDto.id
        val updater = CharlieEntityUpdater.forPrimaryKey(id) {
            bravoId(editDto.bravoId)
        }.build()

        setFields(updater)

    }


    fun updateBravoId(editDto: CharlieUpdate_bravoIdRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateBravoId. currentUser=${currentUser.username}, dto=$editDto")

        val updater = CharlieEntityUpdater.forPrimaryKey(editDto.id) {
            bravoId(editDto.bravoId)
        }.build()

        setFields(updater)

    }


    fun setFields(updater: CharlieEntityUpdater): Int {
        
        val count = this.entityRepo.setFields(updater)
        this.charlieCrudNotifier.onEntityUpdated(updater.id)
        return count
        
    }


    fun delete(id: DomainId) {

        val entityToDelete = this.entityRepo.findByPrimaryKeyOrNull(id)
                ?: return

        this.entityRepo.deleteByPrimaryKey(id)
        this.charlieCrudNotifier.onEntityDeleted(entityToDelete)

    }


}

