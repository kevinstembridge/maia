// This source was generated by the Mahana code generator
// Renderer class: class org.maiaframework.gen.renderers.CrudServiceRenderer

package org.maiaframework.gen.testing.jdbc.sample.simple

import org.maiaframework.domain.DomainId
import org.maiaframework.gen.sample.types.SomeProvidedBooleanType
import org.maiaframework.gen.sample.types.SomeProvidedIntType
import org.maiaframework.gen.sample.types.SomeProvidedLongType
import org.maiaframework.gen.sample.types.SomeProvidedStringType
import org.maiaframework.gen.sample.types.SomeStringType
import org.maiaframework.gen.testing.jdbc.sample.SimpleResponseDto
import org.maiaframework.gen.testing.jdbc.sample.types.SomeBooleanType
import org.maiaframework.gen.testing.jdbc.sample.types.SomeIntType
import org.maiaframework.gen.testing.jdbc.sample.types.SomeLongType
import org.maiaframework.problem.MaiaProblems
import org.maiaframework.webapp.domain.auth.CurrentUserHolder
import org.maiaframework.webapp.domain.auth.MaiaUserDetails
import org.slf4j.LoggerFactory
import org.springframework.stereotype.Component
import java.time.Instant
import java.time.LocalDate
import java.time.Period


@Component
class SimpleCrudService(
    private val entityRepo: SimpleRepo,
    private val mahanaProblems: MaiaProblems,
    private val simpleCrudNotifier: SimpleCrudNotifier
) {


    private val logger = LoggerFactory.getLogger(SimpleCrudService::class.java)


    fun create(createDto: SimpleCreateRequestDto): SimpleEntity {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: create Simple. createdBy=${currentUser.username}, dto=$createDto")

        val entity: SimpleEntity = buildEntity(createDto, currentUser)
        return create(entity)

    }


    private fun buildEntity(createDto: SimpleCreateRequestDto, currentUser: MahanaUserDetails): SimpleEntity {

        val someBoolean: Boolean = createDto.someBoolean
        val someBooleanNullable: Boolean? = createDto.someBooleanNullable
        val someBooleanType: SomeBooleanType = createDto.someBooleanType
        val someBooleanTypeNullable: SomeBooleanType? = createDto.someBooleanTypeNullable
        val someBooleanTypeProvided: SomeProvidedBooleanType = createDto.someBooleanTypeProvided
        val someBooleanTypeProvidedNullable: SomeProvidedBooleanType? = createDto.someBooleanTypeProvidedNullable
        val someDto: SimpleResponseDto = createDto.someDto
        val someDtoNullable: SimpleResponseDto? = createDto.someDtoNullable
        val someEnum: SomeEnum = createDto.someEnum
        val someEnumNullable: SomeEnum? = createDto.someEnumNullable
        val someInstant: Instant = createDto.someInstant
        val someInstantModifiable: Instant = createDto.someInstantModifiable
        val someInstantModifiableNullable: Instant? = createDto.someInstantModifiableNullable
        val someInstantNullable: Instant? = createDto.someInstantNullable
        val someInt: Int = createDto.someInt
        val someIntModifiable: Int = createDto.someIntModifiable
        val someIntNullable: Int? = createDto.someIntNullable
        val someIntType: SomeIntType = createDto.someIntType
        val someIntTypeNullable: SomeIntType? = createDto.someIntTypeNullable
        val someIntTypeProvided: SomeProvidedIntType = createDto.someIntTypeProvided
        val someIntTypeProvidedNullable: SomeProvidedIntType? = createDto.someIntTypeProvidedNullable
        val someListOfEnums: List<SomeEnum> = createDto.someListOfEnums
        val someListOfInstants: List<Instant> = createDto.someListOfInstants
        val someListOfLocalDates: List<LocalDate> = createDto.someListOfLocalDates
        val someListOfPeriods: List<Period> = createDto.someListOfPeriods
        val someListOfStringTypes: List<SomeStringType> = createDto.someListOfStringTypes
        val someListOfStrings: List<String> = createDto.someListOfStrings
        val someLocalDateModifiable: LocalDate = createDto.someLocalDateModifiable
        val someLongType: SomeLongType = createDto.someLongType
        val someLongTypeNullable: SomeLongType? = createDto.someLongTypeNullable
        val someLongTypeProvided: SomeProvidedLongType = createDto.someLongTypeProvided
        val someLongTypeProvidedNullable: SomeProvidedLongType? = createDto.someLongTypeProvidedNullable
        val someMapOfStringToInteger: Map<String, Int> = createDto.someMapOfStringToInteger
        val someMapOfStringTypeToStringType: Map<SomeStringType, SomeStringType> = createDto.someMapOfStringTypeToStringType
        val somePeriodModifiable: Period = createDto.somePeriodModifiable
        val somePeriodNullable: Period? = createDto.somePeriodNullable
        val someProvidedStringType: SomeProvidedStringType = createDto.someProvidedStringType
        val someProvidedStringTypeNullable: SomeProvidedStringType? = createDto.someProvidedStringTypeNullable
        val someString: String = createDto.someString
        val someStringModifiable: String = createDto.someStringModifiable
        val someStringNullable: String? = createDto.someStringNullable
        val someStringType: SomeStringType = createDto.someStringType
        val someStringTypeNullable: SomeStringType? = createDto.someStringTypeNullable
        val createdById = currentUser.userId
        val createdByUsername = currentUser.username
        val id = DomainId.newId()
        val createdTimestampUtc = Instant.now()
        val lastModifiedById = currentUser.userId
        val lastModifiedByUsername = currentUser.username
        val lastModifiedTimestampUtc = createdTimestampUtc

        return SimpleEntity(
            createdById,
            createdByUsername,
            createdTimestampUtc,
            id,
            lastModifiedById,
            lastModifiedByUsername,
            lastModifiedTimestampUtc,
            someBoolean,
            someBooleanNullable,
            someBooleanType,
            someBooleanTypeNullable,
            someBooleanTypeProvided,
            someBooleanTypeProvidedNullable,
            someDto,
            someDtoNullable,
            someEnum,
            someEnumNullable,
            someInstant,
            someInstantModifiable,
            someInstantModifiableNullable,
            someInstantNullable,
            someInt,
            someIntModifiable,
            someIntNullable,
            someIntType,
            someIntTypeNullable,
            someIntTypeProvided,
            someIntTypeProvidedNullable,
            someListOfEnums,
            someListOfInstants,
            someListOfLocalDates,
            someListOfPeriods,
            someListOfStringTypes,
            someListOfStrings,
            someLocalDateModifiable,
            someLongType,
            someLongTypeNullable,
            someLongTypeProvided,
            someLongTypeProvidedNullable,
            someMapOfStringToInteger,
            someMapOfStringTypeToStringType,
            somePeriodModifiable,
            somePeriodNullable,
            someProvidedStringType,
            someProvidedStringTypeNullable,
            someString,
            someStringModifiable,
            someStringNullable,
            someStringType,
            someStringTypeNullable
        )

    }


    fun create(entity: SimpleEntity): SimpleEntity {

        this.entityRepo.insert(entity)
        this.simpleCrudNotifier.onEntityCreated(entity)
        return entity

    }


    fun update(editDto: SimpleUpdateRequestDto) {

        val id = editDto.id
        val updater = SimpleEntityUpdater.forId(id) {
            someInstantModifiable(editDto.someInstantModifiable)
            someIntModifiable(editDto.someIntModifiable)
            someListOfStrings(editDto.someListOfStrings)
            someLocalDateModifiable(editDto.someLocalDateModifiable)
            somePeriodModifiable(editDto.somePeriodModifiable)
            someStringModifiable(editDto.someStringModifiable)
            someInstantModifiableNullable(editDto.someInstantModifiableNullable)
            someIntNullable(editDto.someIntNullable)
            lastModifiedById(CurrentUserHolder.userId)
            lastModifiedTimestampUtc(Instant.now())
        }.build()

        setFields(updater)

    }


    fun updateSomeInstantModifiable(editDto: SimpleUpdate_someInstantModifiableRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateSomeInstantModifiable. currentUser=${currentUser.username}, dto=$editDto")

        val id = editDto.id

        val updater = SimpleEntityUpdater.forId(id) {
            someInstantModifiable(editDto.someInstantModifiable)
        }.build()

        setFields(updater)

    }


    fun updateSomeInstantModifiableNullable(editDto: SimpleUpdate_someInstantModifiableNullableRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateSomeInstantModifiableNullable. currentUser=${currentUser.username}, dto=$editDto")

        val id = editDto.id

        val updater = SimpleEntityUpdater.forId(id) {
            someInstantModifiableNullable(editDto.someInstantModifiableNullable)
        }.build()

        setFields(updater)

    }


    fun updateSomeIntModifiable(editDto: SimpleUpdate_someIntModifiableRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateSomeIntModifiable. currentUser=${currentUser.username}, dto=$editDto")

        val id = editDto.id

        val updater = SimpleEntityUpdater.forId(id) {
            someIntModifiable(editDto.someIntModifiable)
        }.build()

        setFields(updater)

    }


    fun updateSomeIntNullable(editDto: SimpleUpdate_someIntNullableRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateSomeIntNullable. currentUser=${currentUser.username}, dto=$editDto")

        val id = editDto.id

        val updater = SimpleEntityUpdater.forId(id) {
            someIntNullable(editDto.someIntNullable)
        }.build()

        setFields(updater)

    }


    fun updateSomeLocalDateModifiable(editDto: SimpleUpdate_someLocalDateModifiableRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateSomeLocalDateModifiable. currentUser=${currentUser.username}, dto=$editDto")

        val id = editDto.id

        val updater = SimpleEntityUpdater.forId(id) {
            someLocalDateModifiable(editDto.someLocalDateModifiable)
        }.build()

        setFields(updater)

    }


    fun updateSomePeriodModifiable(editDto: SimpleUpdate_somePeriodModifiableRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateSomePeriodModifiable. currentUser=${currentUser.username}, dto=$editDto")

        val id = editDto.id

        val updater = SimpleEntityUpdater.forId(id) {
            somePeriodModifiable(editDto.somePeriodModifiable)
        }.build()

        setFields(updater)

    }


    fun updateSomeStringModifiable(editDto: SimpleUpdate_someStringModifiableRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateSomeStringModifiable. currentUser=${currentUser.username}, dto=$editDto")

        val id = editDto.id

        val updater = SimpleEntityUpdater.forId(id) {
            someStringModifiable(editDto.someStringModifiable)
        }.build()

        setFields(updater)

    }


    fun updateSomeListOfStrings(editDto: SimpleUpdate_someListOfStringsRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateSomeListOfStrings. currentUser=${currentUser.username}, dto=$editDto")

        val id = editDto.id

        val updater = SimpleEntityUpdater.forId(id) {
            someListOfStrings(editDto.someListOfStrings)
        }.build()

        setFields(updater)

    }


    fun setFields(updater: SimpleEntityUpdater): Int {
        
        val count = this.entityRepo.setFields(updater)
        this.simpleCrudNotifier.onEntityUpdated(updater.id)
        return count
        
    }


    fun delete(id: DomainId) {

        val entityToDelete = this.entityRepo.findByIdOrNull(id)
                ?: return

        this.entityRepo.deleteById(id)
        this.simpleCrudNotifier.onEntityDeleted(entityToDelete)

    }


}

