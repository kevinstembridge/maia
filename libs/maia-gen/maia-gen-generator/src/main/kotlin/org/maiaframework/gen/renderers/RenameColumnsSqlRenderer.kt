package org.maiaframework.gen.renderers

import org.maiaframework.gen.spec.definition.EntityDef
import org.maiaframework.gen.spec.definition.EntityHierarchy
import org.maiaframework.gen.spec.definition.lang.ClassFieldName

class RenameColumnsSqlRenderer(
    private val entityHierarchies: List<EntityHierarchy>,
    private val renderedFilePath: String
): AbstractSourceFileRenderer() {


    override fun renderedFilePath(): String {

        return "rename_timestamps.sql"

    }


    override fun renderSource(): String {

        `render header comment`()

        this.entityHierarchies.forEach { `render CREATE TABLE statement for`(it) }

        return sourceCode.toString()

    }


    private fun `render header comment`() {

        appendLine("-- This source was generated by the Maia Framework code generator")
        appendLine("-- Renderer class: $javaClass")

    }


    private fun `render CREATE TABLE statement for`(entityHierarchy: EntityHierarchy) {

        val baseEntityDef = entityHierarchy.entityDef

        if (baseEntityDef.hasFieldNamed(ClassFieldName.createdTimestampUtc)) {
            appendLine("ALTER TABLE ${schemaAndTableNameFor(baseEntityDef)} RENAME COLUMN c_ts TO created_timestamp_utc;")
        }

        if (baseEntityDef.hasFieldNamed(ClassFieldName.lastModifiedTimestampUtc)) {
            appendLine("ALTER TABLE ${schemaAndTableNameFor(baseEntityDef)} RENAME COLUMN lm_ts TO last_modified_timestamp_utc;")
        }

        if (baseEntityDef.hasFieldNamed(ClassFieldName.lastModifiedById)) {
            appendLine("ALTER TABLE ${schemaAndTableNameFor(baseEntityDef)} RENAME COLUMN lm_by_id to last_modified_by_id;")
        }

        if (baseEntityDef.hasFieldNamed(ClassFieldName.lastModifiedByUsername)) {
            appendLine("ALTER TABLE ${schemaAndTableNameFor(baseEntityDef)} RENAME COLUMN lm_by_name to last_modified_by_name;")
        }

    }


    private fun schemaAndTableNameFor(entityDef: EntityDef) = "${entityDef.schemaName}.${entityDef.tableName.rawTableName}"


}
