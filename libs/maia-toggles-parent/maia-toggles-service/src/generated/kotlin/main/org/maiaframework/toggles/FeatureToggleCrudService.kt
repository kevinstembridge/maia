// This source was generated by the Maia Framework code generator
// Renderer class: class org.maiaframework.gen.renderers.CrudServiceRenderer

package org.maiaframework.toggles

import org.maiaframework.problem.MaiaProblems
import org.maiaframework.webapp.domain.auth.CurrentUserHolder
import org.slf4j.LoggerFactory
import org.springframework.stereotype.Component
import java.time.Instant


@Component
class FeatureToggleCrudService(
    private val entityRepo: FeatureToggleRepo,
    private val featureToggleCrudNotifier: FeatureToggleCrudNotifier,
    private val maiaProblems: MaiaProblems
) {


    private val logger = LoggerFactory.getLogger(FeatureToggleCrudService::class.java)


    fun create(entity: FeatureToggleEntity): FeatureToggleEntity {

        this.entityRepo.insert(entity)
        this.featureToggleCrudNotifier.onEntityCreated(entity)
        return entity

    }


    fun update(editDto: FeatureToggleUpdateRequestDto) {

        val featureName = editDto.featureName
        val version = editDto.version
        val updater = FeatureToggleEntityUpdater.forPrimaryKey(featureName, version) {
            activationStrategies(editDto.activationStrategies)
            lastModifiedTimestampUtc(Instant.now())
        }

        setFields(updater)

    }


    fun updateActivationStrategies(editDto: FeatureToggleUpdate_activationStrategiesRequestDto) {

        val currentUser = CurrentUserHolder.currentUser

        logger.info("BEGIN: updateActivationStrategies. currentUser=${currentUser.username}, dto=$editDto")

        val version = editDto.version

        val updater = FeatureToggleEntityUpdater.forPrimaryKey(editDto.featureName, version) {
            activationStrategies(editDto.activationStrategies)
        }

        setFields(updater)

    }


    fun setFields(updater: FeatureToggleEntityUpdater): Int {
        
        val count = this.entityRepo.setFields(updater)
        this.featureToggleCrudNotifier.onEntityUpdated(updater.featureName)
        return count
        
    }


    fun delete(featureName: FeatureName) {

        val entityToDelete = this.entityRepo.findByPrimaryKeyOrNull(featureName)
                ?: return

        this.entityRepo.deleteByPrimaryKey(featureName)
        this.featureToggleCrudNotifier.onEntityDeleted(entityToDelete)

    }


}

