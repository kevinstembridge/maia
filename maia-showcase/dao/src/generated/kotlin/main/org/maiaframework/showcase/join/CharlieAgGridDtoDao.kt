// This source was generated by the Maia Framework code generator
// Renderer class: class org.maiaframework.gen.renderers.SearchableDtoJdbcDaoRenderer

package org.maiaframework.showcase.join

import org.maiaframework.domain.search.SearchModel
import org.maiaframework.domain.search.SearchResultPage
import org.maiaframework.jdbc.JdbcOps
import org.maiaframework.jdbc.SqlParams
import org.maiaframework.jdbc.search.MaiaSearchModelConverter
import org.springframework.stereotype.Repository


@Repository
class CharlieAgGridDtoDao(
    private val jdbcOps: JdbcOps
) {


    private val dtoRowMapper = CharlieAgGridDtoRowMapper()


    private val searchModelConverter = MaiaSearchModelConverter(
            CharlieAgGridDtoMeta::fieldNameToColumnName
    )        


    fun search(searchModel: SearchModel): SearchResultPage<CharlieAgGridDto> {

        val sqlParams = SqlParams()
        val whereClause = this.searchModelConverter.buildWhereClauseFor(searchModel.filterModel, sqlParams)
        val offsetAndLimitClause = this.searchModelConverter.buildOffsetAndLimitFor(searchModel)
        val orderByClause = this.searchModelConverter.buildOrderByClause(searchModel)

        val sqlForTotalCount = """
            select count(*)
            from maia.charlie_ag_grid
            inner join maia.bravo_ag_grid
                    on maia.charlie_ag_grid.bravo_id = maia.bravo_ag_grid.id
            inner join maia.alpha_ag_grid
                    on maia.bravo_ag_grid.alpha_id = maia.alpha_ag_grid.id
            $whereClause
            """.trimIndent()

        val sqlForPage = """
            select
                maia.charlie_ag_grid.created_timestamp_utc as createdTimestampUtc,
                maia.alpha_ag_grid.some_int as dtoIntFromAlpha,
                maia.bravo_ag_grid.some_int as dtoIntFromBravo,
                maia.charlie_ag_grid.some_int as dtoIntFromCharlie,
                maia.alpha_ag_grid.some_string as dtoStringFromAlpha,
                maia.bravo_ag_grid.some_string as dtoStringFromBravo,
                maia.charlie_ag_grid.some_string as dtoStringFromCharlie
            from maia.charlie_ag_grid
            inner join maia.bravo_ag_grid
                    on maia.charlie_ag_grid.bravo_id = maia.bravo_ag_grid.id
            inner join maia.alpha_ag_grid
                    on maia.bravo_ag_grid.alpha_id = maia.alpha_ag_grid.id
            $whereClause
            $orderByClause
            $offsetAndLimitClause
            """.trimIndent()

        val totalResultCount = this.jdbcOps.queryForLong(sqlForTotalCount, sqlParams)
        val results = this.jdbcOps.queryForList(sqlForPage, sqlParams, this.dtoRowMapper)
        val endRow = searchModel.endRow
        val limit = if (endRow == null) null else (endRow - searchModel.startRow)

        return SearchResultPage(
            results,
            totalResultCount,
            searchModel.startRow,
            limit
        )

    }


    fun count(searchModel: SearchModel): Long {

        val sqlParams = SqlParams()
        val whereClause = this.searchModelConverter.buildWhereClauseFor(searchModel.filterModel, sqlParams)

        val sqlForTotalCount = """
            select count(*)
            from maia.charlie_ag_grid
            inner join maia.bravo_ag_grid
                    on maia.charlie_ag_grid.bravo_id = maia.bravo_ag_grid.id
            inner join maia.alpha_ag_grid
                    on maia.bravo_ag_grid.alpha_id = maia.alpha_ag_grid.id
            $whereClause
            """.trimIndent()

        return this.jdbcOps.queryForLong(sqlForTotalCount, sqlParams)

    }


}

