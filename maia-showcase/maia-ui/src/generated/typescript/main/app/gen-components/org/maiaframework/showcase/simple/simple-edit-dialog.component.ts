// This source was generated by the Maia Framework code generator
// Renderer class: class org.maiaframework.gen.renderers.ui.EntityFormComponentRenderer

import {Component, OnInit, signal} from '@angular/core';
import {FormsModule, ReactiveFormsModule} from '@angular/forms';
import {FormField, form, maxLength, minLength, required, submit, validateHttp} from '@angular/forms/signals';
import {MatAutocompleteModule} from '@angular/material/autocomplete';
import {MatButtonModule} from '@angular/material/button';
import {MatOptionModule} from '@angular/material/core';
import {MatDialog, MatDialogActions, MatDialogContent, MatDialogRef, MatDialogTitle} from '@angular/material/dialog';
import {MatFormFieldModule} from '@angular/material/form-field';
import {MatInputModule} from '@angular/material/input';
import {ProblemDetail} from '@app/gen-components/common/model/ProblemDetail';
import {SimpleUpdateRequestDto} from '@app/gen-components/org/maiaframework/showcase/simple/SimpleUpdateRequestDto';
import {SimpleCrudService} from '@app/gen-components/org/maiaframework/showcase/simple/simple-crud.service';
import {Observable, Subject, of} from 'rxjs';
import {catchError, debounceTime, distinctUntilChanged, filter, map, switchMap, tap} from 'rxjs/operators';



@Component({
    imports: [
        FormField,
        FormsModule,
        MatAutocompleteModule,
        MatButtonModule,
        MatDialogActions,
        MatDialogContent,
        MatDialogTitle,
        MatFormFieldModule,
        MatInputModule,
        MatOptionModule,
        ReactiveFormsModule,
    ],
    selector: 'app-simple-edit-dialog',
    styleUrls: ['./simple-edit-dialog.component.scss'],
    templateUrl: './simple-edit-dialog.component.html'
})
export class SimpleEditDialogComponent implements OnInit {


    dialogFormModel = signal<SimpleUpdateRequestDto>({
        id: '',
        someString: '',
    });


    dialogForm = form(this.dialogFormModel, (schemaPath) => {
        required(schemaPath.someString, { message: 'Some String is required' })
        minLength(schemaPath.someString, 3)
        maxLength(schemaPath.someString, 100)
        validateHttp(schemaPath.someString, {
            request: ({value}) => {
                return {
                    url: 'someString.huh',
                    body: value(),
                }
            },
            onSuccess: (response: any) => {
                if (response.huh) {
                    return {
                        kind: 'huh',
                        message: 'huh'
                    };
                }
                return null;
            },
            onError: (error) => ({
                kind: 'huh',
                message: 'huh'
            }),
        });
        required(schemaPath.id, { message: 'ID is required' })
    });


    problemDetail = signal<ProblemDetail | null>(null);


    constructor(
        public dialogRef: MatDialogRef<SimpleEditDialogComponent>,
        private formService: SimpleCrudService,
        @Inject(MAT_DIALOG_DATA) private dto: any,
    ) {}


    ngOnInit() {

    }


    async onSubmit(e: Event) {

        e.preventDefault();

        this.problemDetail.set(null);

        await submit(this.dialogForm, async (form) => {

            this.formService.edit(form().value())
                .subscribe({
                    next: () => {
                        this.dialogRef.close(true);
                    },
                    error: err => {
                        this.problemDetail.set(err.error);
                    }
                });

        });

    }


    onCancel(): void {
        this.dialogRef.close();
    }


}

