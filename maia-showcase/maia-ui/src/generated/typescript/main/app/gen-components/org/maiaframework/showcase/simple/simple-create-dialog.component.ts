// This source was generated by the Maia Framework code generator
// Renderer class: class org.maiaframework.gen.renderers.ui.EntityFormComponentRenderer

import {Component, OnInit, signal} from '@angular/core';
import {form, FormField, max, min, required, submit, validateHttp} from '@angular/forms/signals';
import {FormsModule, ReactiveFormsModule} from '@angular/forms';
import {MatAutocompleteModule} from '@angular/material/autocomplete';
import {MatButtonModule} from '@angular/material/button';
import {MatOptionModule} from '@angular/material/core';
import {MatDialogActions, MatDialogContent, MatDialogRef, MatDialogTitle} from '@angular/material/dialog';
import {MatFormFieldModule} from '@angular/material/form-field';
import {MatInputModule} from '@angular/material/input';
import {ProblemDetail} from '@app/gen-components/common/model/ProblemDetail';
import {SimpleCreateRequestDto} from '@app/gen-components/org/maiaframework/showcase/simple/SimpleCreateRequestDto';
import {SimpleCrudService} from '@app/gen-components/org/maiaframework/showcase/simple/simple-crud.service';


@Component({
    imports: [
        FormField,
        FormsModule,
        MatAutocompleteModule,
        MatButtonModule,
        MatDialogActions,
        MatDialogContent,
        MatDialogTitle,
        MatFormFieldModule,
        MatInputModule,
        MatOptionModule,
        ReactiveFormsModule,
    ],
    selector: 'app-simple-create-dialog',
    styleUrls: ['./simple-create-dialog.component.scss'],
    templateUrl: './simple-create-dialog.component.html'
})
export class SimpleCreateDialogComponent implements OnInit {


    dialogFormModel = signal<SimpleCreateRequestDto>({
        someString: '',
    });


    dialogForm = form(this.dialogFormModel, (schemaPath) => {
        required(schemaPath.someString, { message: 'Some String is required' })
        min(schemaPath.someString, 3)
        max(schemaPath.someString, 100)
        validateHttp(schemaPath.someString, {
            request: ({value}) => {
                return {
                    url: '/api/simple/exists_by_some_string',
                    body: value(),
                }
            },
            onSuccess: (response: any) => {
                if (response.taken) {
                    return {
                        kind: 'usernameTaken',
                        message: 'Username is already taken',
                    };
                }
                return null;
            },
            onError: (error) => ({
                kind: 'networkError',
                message: 'Could not verify Some String',
            }),
        });
    });


    problemDetail = signal<ProblemDetail | null>(null);


    constructor(
        public dialogRef: MatDialogRef<SimpleCreateDialogComponent>,
        private formService: SimpleCrudService,
    ) {


    }


    ngOnInit() {

    }


    async onSubmit(e: Event) {

        e.preventDefault();

        this.problemDetail.set(null);

        await submit(this.dialogForm, async (form) => {

            this.formService.create(form().value())
                .subscribe({
                    next: () => {
                        this.dialogRef.close(true);
                    },
                    error: err => {
                        this.problemDetail.set(err.error);
                    }
                });

        });

    }


    onCancel(): void {
        this.dialogRef.close();
    }


}
