// This source was generated by the Maia Framework code generator
// Renderer class: class org.maiaframework.gen.renderers.ui.EntityReactiveFormComponentRenderer

import {Component, EventEmitter, Inject, OnInit, Output, signal} from '@angular/core';
import {FormControl, FormGroup, FormsModule, ReactiveFormsModule, Validators} from '@angular/forms';
import {MatAutocompleteModule} from '@angular/material/autocomplete';
import {MatButtonModule} from '@angular/material/button';
import {MatOptionModule} from '@angular/material/core';
import {MAT_DIALOG_DATA, MatDialog, MatDialogActions, MatDialogContent, MatDialogRef, MatDialogTitle} from '@angular/material/dialog';
import {MatFormFieldModule} from '@angular/material/form-field';
import {MatInputModule} from '@angular/material/input';
import {ProblemDetail} from '@app/gen-components/common/model/ProblemDetail';
import {UserUpdateRequestDto} from '@app/gen-components/org/maiaframework/showcase/user/UserUpdateRequestDto';
import {UserCrudService} from '@app/gen-components/org/maiaframework/showcase/user/user-crud.service';
import {Observable, Subject, of} from 'rxjs';
import {catchError, debounceTime, distinctUntilChanged, filter, map, switchMap, tap} from 'rxjs/operators';



@Component({
    imports: [
        FormsModule,
        MatAutocompleteModule,
        MatButtonModule,
        MatDialogActions,
        MatDialogContent,
        MatDialogTitle,
        MatFormFieldModule,
        MatInputModule,
        MatOptionModule,
        ReactiveFormsModule,
    ],
    selector: 'app-user-edit-dialog',
    styleUrls: ['./user-edit-dialog.component.scss'],
    templateUrl: './user-edit-dialog.component.html'
})
export class UserEditDialogComponent implements OnInit {


    problemDetail = signal<ProblemDetail | null>(null);


    formGroup: FormGroup;


    constructor(
        public dialogRef: MatDialogRef<UserEditDialogComponent>,
        private formService: UserCrudService,
        @Inject(MAT_DIALOG_DATA) private dto: any,
    ) {

        this.formGroup = new FormGroup(
            {
                encryptedPassword: new FormControl({value: dto.encryptedPassword, disabled: true}),
                someStrings: new FormControl({value: dto.someStrings, disabled: true}),
                firstName: new FormControl(dto.firstName, { updateOn: 'change', validators: [Validators.maxLength(100)] }),
                lastName: new FormControl(dto.lastName, { updateOn: 'change', validators: [Validators.required, Validators.maxLength(100)] }),
                emailAddress: new FormControl({value: dto.emailAddress, disabled: true}),
                displayName: new FormControl({value: dto.displayName, disabled: true}),
                lifecycleState: new FormControl({value: dto.lifecycleState, disabled: true}),
                id: new FormControl({value: dto.id, disabled: true}),
                version: new FormControl({value: dto.version, disabled: true}),
            },
        );

    }


    ngOnInit() {

    }


    onSubmit() {

        this.problemDetail.set(null);

        if (this.formGroup.invalid) {
            return;
        }

        const requestDto = {
            id: this.formGroup.getRawValue().id,
            lastName: this.formGroup.getRawValue().lastName,
            version: this.formGroup.getRawValue().version,
            firstName: this.formGroup.getRawValue().firstName,
        } as UserUpdateRequestDto;

        this.formService.edit(requestDto)
            .subscribe({
                next: () => {
                    this.dialogRef.close(true);
                },
                error: err => {
                    this.problemDetail.set(err.error);
                }
            });

    }


    onCancel(): void {
        this.dialogRef.close();
    }


}

